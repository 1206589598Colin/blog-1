---
title: 分布式存储基本原理
categories: ['分布式']
tags: ['分布式', '存储']
date: 2019-08-21 11:30
---

# 分布式存储基本原理

> 📦 本文已归档到：「[blog](https://github.com/dunwu/blog)」

## 一、分区规则

**分布式数据库** 首先要解决把 **整个数据集** 按照 **分区规则** 映射到 **多个节点** 的问题，即把 **数据集** 划分到 **多个节点** 上，每个节点负责 **整体数据** 的一个 **子集**。

<div align="center">
<img src="http://dunwu.test.upcdn.net/cs/design/architecture/partition-rule.png" />
</div>


数据分布通常有 **哈希分区** 和 **顺序分区** 两种方式，对比如下：

| 分区方式 | 特点                                             | 相关产品                         |
| :------- | :----------------------------------------------- | :------------------------------- |
| 哈希分区 | 离散程度好，数据分布与业务无关，无法顺序访问     | Redis Cluster，Cassandra，Dynamo |
| 顺序分区 | 离散程度易倾斜，数据分布与业务相关，可以顺序访问 | BigTable，HBase，Hypertable      |

由于 `Redis Cluster` 采用 **哈希分区规则**，这里重点讨论 **哈希分区**。常见的 **哈希分区** 规则有几种，下面分别介绍：

### 1.1. 节点取余分区

使用特定的数据，如 `Redis` 的 **键** 或 **用户** `ID`，再根据 **节点数量** `N` 使用公式：`hash（key）% N` 计算出 **哈希值**，用来决定数据 **映射** 到哪一个节点上。

<div align="center">
<img src="http://dunwu.test.upcdn.net/cs/design/architecture/partition-hash-mod.png" />
</div>


- **优点**

这种方式的突出优点是 **简单性**，常用于 **数据库** 的 **分库分表规则**。一般采用 **预分区** 的方式，提前根据 **数据量** 规划好 **分区数**，比如划分为 `512` 或 `1024` 张表，保证可支撑未来一段时间的 **数据容量**，再根据 **负载情况** 将 **表** 迁移到其他 **数据库** 中。扩容时通常采用 **翻倍扩容**，避免 **数据映射** 全部被 **打乱**，导致 **全量迁移** 的情况。

- **缺点**

当 **节点数量** 变化时，如 **扩容** 或 **收缩** 节点，数据节点 **映射关系** 需要重新计算，会导致数据的 **重新迁移**。



> **注意**：因为 **一致性哈希分区** 的这些缺点，一些分布式系统采用 **虚拟槽** 对 **一致性哈希** 进行改进，比如 `Dynamo` 系统。

## 参考资料

- [深入剖析 Redis 系列(三) - Redis 集群模式搭建与原理详解](https://juejin.im/post/5b8fc5536fb9a05d2d01fb11)
